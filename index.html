<script>
/* =========================
   J&M Hybrid V40 (refactor seguro + offline + merge)
   - Sin XSS (no innerHTML con user data)
   - Offline-first (localStorage)
   - Sync con merge por tx.updatedAt
   - fetch timeout + retry
========================= */

const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
const LS_KEY = "jmhybrid:v40:data";

const $ = (id) => document.getElementById(id);

const months = ["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"];

const formatMoney = (n) => {
  const v = Number(n);
  if (!Number.isFinite(v)) return "$0";
  return "$" + Math.trunc(v).toLocaleString();
};

const nowISODate = () => new Date().toISOString().split("T")[0];
const nowYM = () => new Date().toISOString().slice(0, 7);

const uid = () => {
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  return String(Date.now()) + "-" + Math.random().toString(16).slice(2);
};

function loader(on) { $("loader").style.display = on ? "flex" : "none"; }
function setSyncDot(color) { $("syncDot").style.background = color; } // gray/orange/green/red

function safeNumber(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : NaN;
}

function fetchWithTimeout(url, opts = {}, ms = 9000) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), ms);
  return fetch(url, { ...opts, signal: ctrl.signal })
    .finally(() => clearTimeout(t));
}

async function fetchJSON(url, opts, { retries = 2, timeout = 9000 } = {}) {
  let lastErr;
  for (let i = 0; i <= retries; i++) {
    try {
      const res = await fetchWithTimeout(url, opts, timeout);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch (e) {
      lastErr = e;
      await new Promise(r => setTimeout(r, 300 * (i + 1)));
    }
  }
  throw lastErr;
}

/* ===== Estado ===== */
let data = {
  txs: [],
  cats: { exp: ["Super","Casa","Salidas","Servicios"], inc: ["Sueldo","Ventas"] },
  concepts: { "Super": ["Coto"], "Casa": ["Alquiler"] }
};

let editId = null;
let currentTxs = [];
let chartInstance = null;
let filterId = null; // story filter
let tempCat = "";
let tempLink = "";

/* ===== Persistencia local ===== */
function loadLocal() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    if (parsed && typeof parsed === "object" && Array.isArray(parsed.txs)) data = hardenData(parsed);
  } catch {}
}

function saveLocal() {
  try { localStorage.setItem(LS_KEY, JSON.stringify(data)); } catch {}
}

function hardenData(d) {
  // normaliza estructura mínima
  const out = {
    txs: Array.isArray(d.txs) ? d.txs : [],
    cats: d.cats && typeof d.cats === "object" ? d.cats : { exp: [], inc: [] },
    concepts: d.concepts && typeof d.concepts === "object" ? d.concepts : {}
  };
  out.cats.exp = Array.isArray(out.cats.exp) ? out.cats.exp : [];
  out.cats.inc = Array.isArray(out.cats.inc) ? out.cats.inc : [];
  return out;
}

/* ===== Merge por tx.updatedAt ===== */
function mergeCloud(local, cloud) {
  const L = hardenData(local);
  const C = hardenData(cloud);

  const byId = new Map();

  for (const t of L.txs) byId.set(String(t.id), t);
  for (const t of C.txs) {
    const k = String(t.id);
    const prev = byId.get(k);
    if (!prev) byId.set(k, t);
    else {
      const a = Number(prev.updatedAt || 0);
      const b = Number(t.updatedAt || 0);
      byId.set(k, (b >= a) ? t : prev);
    }
  }

  // cats y concepts: unión simple
  const cats = { exp: [], inc: [] };
  const addUniq = (arr, v) => { if (v && !arr.includes(v)) arr.push(v); };

  for (const v of (L.cats.exp || [])) addUniq(cats.exp, v);
  for (const v of (C.cats.exp || [])) addUniq(cats.exp, v);
  for (const v of (L.cats.inc || [])) addUniq(cats.inc, v);
  for (const v of (C.cats.inc || [])) addUniq(cats.inc, v);

  const concepts = { ...(L.concepts || {}) };
  for (const [k, arr] of Object.entries(C.concepts || {})) {
    if (!Array.isArray(arr)) continue;
    if (!Array.isArray(concepts[k])) concepts[k] = [];
    for (const v of arr) if (v && !concepts[k].includes(v)) concepts[k].push(v);
  }

  return { txs: Array.from(byId.values()), cats, concepts };
}

/* ===== Sync ===== */
async function forceSync() {
  loader(true);
  setSyncDot("#F59E0B"); // naranja (syncing)
  try {
    const cloud = await fetchJSON(API_URL, {}, { retries: 2, timeout: 9000 });
    if (cloud && cloud.txs) {
      const merged = mergeCloud(data, cloud);
      data = merged;
      saveLocal();
      await pushToCloud(); // opcional: sube merge para converger
    }
    loadData();
    setSyncDot("#10B981"); // green
  } catch (e) {
    // si no hay red, al menos seguimos en local
    setSyncDot("#EF4444"); // red
    loadData();
  } finally {
    loader(false);
  }
}

async function pushToCloud() {
  // subida con retry; no bloquea UI demasiado
  try {
    await fetchJSON(API_URL, { method: "POST", body: JSON.stringify(data) }, { retries: 1, timeout: 9000 });
  } catch (e) {
    // queda en local; dot rojo si querés: aquí lo dejamos “warning”
    setSyncDot("#F59E0B");
  }
}

async function saveData() {
  // guarda local inmediato (optimista) y empuja a cloud
  saveLocal();
  loadData();
  setSyncDot("#F59E0B");
  loader(true);
  await pushToCloud();
  loader(false);
  if ($("syncDot").style.background !== "rgb(239, 68, 68)") setSyncDot("#10B981");
}

/* ===== Inicialización ===== */
window.addEventListener("load", () => {
  loadLocal();

  $("dateInput").value = nowYM();
  $("fDate").value = nowISODate();

  // si tenés onclick inline, no estorba; esto agrega robustez si los quitás después
  $("txForm").addEventListener("submit", onSubmitTx);

  // primer render con local, luego sync
  loadData();
  forceSync();
});

/* ===== Carga mensual ===== */
function loadData() {
  const ym = $("dateInput").value;
  const [y, m] = ym.split("-");
  $("monthTxt").innerText = `${months[parseInt(m, 10) - 1]} ${y}`;

  currentTxs = (data.txs || []).filter(t => String(t.date || "").startsWith(ym));
  renderStories();
  renderFeed(filterId);
  renderChart();
}

/* ===== Render: Stories ===== */
function renderStories() {
  const tray = $("storiesTray");
  tray.textContent = "";

  const incomes = currentTxs.filter(t => t.type === "inc").sort((a,b) => (b.amount||0) - (a.amount||0));
  const expenses = currentTxs.filter(t => t.type === "exp");

  tray.appendChild(storyNode({
    active: filterId === null,
    icon: "fa-wallet",
    title: "Todo",
    badge: "",
    ringPct: 100,
    ringColor: "var(--primary)",
    onClick: () => setFilter(null)
  }));

  for (const inc of incomes) {
    const spent = expenses
      .filter(e => String(e.linkId || "") === String(inc.id))
      .reduce((a,b) => a + (Number(b.amount)||0), 0);

    const remain = (Number(inc.amount)||0) - spent;
    const pct = (Number(inc.amount)||0) > 0 ? (remain / inc.amount) * 100 : 0;
    const ringPct = Math.max(0, Math.min(100, pct));

    const color = remain < 0 ? "#EF4444" : (ringPct > 20 ? "#10B981" : "#F59E0B");
    const badge = Number.isFinite(remain) ? `${Math.floor(remain/1000)}k` : "";

    tray.appendChild(storyNode({
      active: String(filterId) === String(inc.id),
      icon: "fa-dollar-sign",
      title: String(inc.desc || "Ingreso"),
      badge,
      ringPct,
      ringColor: color,
      onClick: () => setFilter(inc.id)
    }));
  }
}

function storyNode({ active, icon, title, badge, ringPct, ringColor, onClick }) {
  const item = document.createElement("div");
  item.className = "story-item" + (active ? " active" : "");
  item.addEventListener("click", onClick);

  const ring = document.createElement("div");
  ring.className = "ring-container";
  ring.style.background = `conic-gradient(${ringColor} ${ringPct}%, #E2E8F0 0)`;

  const avatar = document.createElement("div");
  avatar.className = "avatar";
  const i = document.createElement("i");
  i.className = `fas ${icon}`;
  avatar.appendChild(i);

  ring.appendChild(avatar);

  if (badge) {
    const b = document.createElement("div");
    b.className = "story-badge";
    b.textContent = badge;
    ring.appendChild(b);
  }

  const name = document.createElement("span");
  name.className = "story-name";
  name.textContent = title;

  item.appendChild(ring);
  item.appendChild(name);
  return item;
}

function setFilter(id) {
  filterId = id;
  renderStories();
  renderFeed(id);
}

/* ===== Render: Feed + KPI ===== */
function renderFeed(fId) {
  const list = $("feedList");
  list.textContent = "";

  let txs = [...currentTxs];
  let title = "Todos los movimientos";

  if (fId) {
    const inc = txs.find(t => String(t.id) === String(fId));
    if (inc) title = `Gastos de: ${String(inc.desc || "")}`;
    txs = txs.filter(t => String(t.id) === String(fId) || String(t.linkId || "") === String(fId));
  }

  txs.sort((a,b) => String(b.date||"").localeCompare(String(a.date||"")) || String(b.id).localeCompare(String(a.id)));

  const sumInc = currentTxs.filter(t=>t.type==="inc").reduce((a,b)=>a+(Number(b.amount)||0),0);
  const sumExp = currentTxs.filter(t=>t.type==="exp").reduce((a,b)=>a+(Number(b.amount)||0),0);

  $("kpiVal").innerText = formatMoney(sumInc - sumExp);
  $("kpiSpent").innerText = formatMoney(sumExp);
  $("feedTitle").innerText = title;

  if (txs.length === 0) {
    const empty = document.createElement("div");
    empty.style.cssText = "text-align:center; padding:30px; color:#94A3B8;";
    empty.textContent = "Sin movimientos aquí";
    list.appendChild(empty);
    return;
  }

  const frag = document.createDocumentFragment();

  for (const t of txs) {
    const li = document.createElement("li");
    li.className = "feed-item";
    li.addEventListener("click", () => edit(t.id));

    const isInc = t.type === "inc";

    const icon =
      isInc ? "fa-arrow-down" :
      (t.cat === "Super" ? "fa-shopping-cart" :
      (t.cat === "Casa" ? "fa-home" : "fa-receipt"));

    const bg = isInc ? "#ECFDF5" : "#F1F5F9";

    // linkName
    let linkName = "";
    if (!isInc && t.linkId) {
      const p = currentTxs.find(x => String(x.id) === String(t.linkId));
      if (p) linkName = String(p.desc || "");
    }

    const fIcon = document.createElement("div");
    fIcon.className = "f-icon";
    fIcon.style.background = bg;
    fIcon.style.color = isInc ? "var(--inc)" : "var(--txt-sec)";
    const ii = document.createElement("i");
    ii.className = `fas ${icon}`;
    fIcon.appendChild(ii);

    const content = document.createElement("div");
    content.className = "f-content";

    const row = document.createElement("div");
    row.className = "f-row";

    const desc = document.createElement("span");
    desc.className = "f-desc";
    desc.textContent = String(t.desc || "");
    if (!t.exec) {
      desc.style.textDecoration = "line-through";
      desc.style.opacity = "0.5";
    }

    const amt = document.createElement("span");
    amt.className = "f-amt";
    amt.style.color = isInc ? "var(--inc)" : "var(--txt)";
    const sign = isInc ? "+" : "-";
    amt.textContent = `${sign} ${formatMoney(t.amount)}`;

    row.appendChild(desc);
    row.appendChild(amt);

    const meta = document.createElement("div");
    meta.className = "f-meta";

    const pillCat = document.createElement("span");
    pillCat.className = "pill";
    pillCat.textContent = String(t.cat || "");

    const day = document.createElement("span");
    day.textContent = String(t.date || "").split("-")[2] || "";

    meta.appendChild(pillCat);
    meta.appendChild(day);

    if (linkName) {
      const pillLink = document.createElement("span");
      pillLink.className = "pill link";
      const linkI = document.createElement("i");
      linkI.className = "fas fa-link";
      pillLink.appendChild(linkI);
      pillLink.appendChild(document.createTextNode(" " + linkName));
      meta.appendChild(pillLink);
    }

    content.appendChild(row);
    content.appendChild(meta);

    li.appendChild(fIcon);
    li.appendChild(content);

    frag.appendChild(li);
  }

  list.appendChild(frag);
}

/* ===== Form ===== */
function openSheet() { if (!editId) resetForm(); $("sheet").classList.add("open"); }
function closeSheet() { $("sheet").classList.remove("open"); }

function resetForm() {
  editId = null;
  $("txForm").reset();
  $("fDate").value = nowISODate();
  $("btnDel").style.display = "none";
  $("btnSave").innerText = "GUARDAR";
  setType("exp");
  tempCat = "";
  tempLink = "";
  renderLinkChips();
}

function setType(t) {
  $("fType").value = t;
  $("type-exp").className = `chip ${t==="exp" ? "active" : ""}`;
  $("type-inc").className = `chip ${t==="inc" ? "active" : ""}`;
  $("linkGroup").style.display = (t === "exp") ? "block" : "none";
  renderCatChips(t);
}

function renderCatChips(type) {
  const div = $("catChips");
  div.textContent = "";

  if (!data.cats[type]) data.cats[type] = [];

  const addBtn = document.createElement("div");
  addBtn.className = "chip";
  addBtn.innerHTML = '<i class="fas fa-plus"></i>';
  addBtn.addEventListener("click", () => {
    const n = prompt("Nueva Categoria:");
    if (!n) return;
    if (!data.cats[type].includes(n)) data.cats[type].push(n);
    if (!data.concepts[n]) data.concepts[n] = [];
    saveData();
    pickCat(n);
  });
  div.appendChild(addBtn);

  for (const c of data.cats[type]) {
    const el = document.createElement("div");
    el.className = `chip ${tempCat === c ? "active" : ""}`;
    el.textContent = c;
    el.addEventListener("click", () => pickCat(c));
    div.appendChild(el);
  }

  if (tempCat && data.cats[type].includes(tempCat)) renderConceptChips(tempCat);
  else $("conceptChips").textContent = "";
}

function pickCat(c) {
  tempCat = c;
  $("fCat").value = c;
  renderCatChips($("fType").value);
  renderConceptChips(c);
}

function renderConceptChips(cat) {
  const div = $("conceptChips");
  div.textContent = "";

  if (!data.concepts[cat]) data.concepts[cat] = [];

  const customBtn = document.createElement("div");
  customBtn.className = "chip";
  customBtn.textContent = "+ Nuevo";
  customBtn.addEventListener("click", () => {
    $("fConcept").value = "new_c";
    $("fCustomDesc").style.display = "block";
    $("fCustomDesc").value = "";
    $("fCustomDesc").focus();
    renderConceptChips(cat);
  });
  div.appendChild(customBtn);

  for (const c of data.concepts[cat]) {
    const el = document.createElement("div");
    el.className = "chip" + ($("fConcept").value === c ? " active" : "");
    el.textContent = c;
    el.addEventListener("click", () => {
      $("fConcept").value = c;
      $("fCustomDesc").style.display = "none";
      renderConceptChips(cat);
    });
    div.appendChild(el);
  }
}

function renderLinkChips() {
  const div = $("linkChips");
  div.textContent = "";

  const def = document.createElement("div");
  def.className = `chip link-chip ${!tempLink ? "active" : ""}`;
  def.textContent = "Fondo General";
  def.addEventListener("click", () => {
    tempLink = "";
    $("fLink").value = "";
    renderLinkChips();
  });
  div.appendChild(def);

  const incs = currentTxs.filter(t => t.type === "inc");
  for (const i of incs) {
    const el = document.createElement("div");
    el.className = `chip link-chip ${String(tempLink) === String(i.id) ? "active" : ""}`;
    el.textContent = `${String(i.desc || "Ingreso")} (${formatMoney(i.amount)})`;
    el.addEventListener("click", () => {
      tempLink = i.id;
      $("fLink").value = String(i.id);
      renderLinkChips();
    });
    div.appendChild(el);
  }
}

function onSubmitTx(e) {
  e.preventDefault();

  const type = $("fType").value;
  const amount = safeNumber($("fAmount").value);
  const date = $("fDate").value;

  if (!date) return alert("Fecha inválida");
  if (!Number.isFinite(amount) || amount <= 0) return alert("Monto inválido");

  const cat = $("fCat").value;
  if (!cat) return alert("Selecciona categoría");

  let desc = $("fConcept").value;
  if (desc === "new_c" || !desc) {
    desc = ($("fCustomDesc").value || "").trim();
    if (!desc) return alert("Escribe el concepto");
    if (!data.concepts[cat]) data.concepts[cat] = [];
    if (!data.concepts[cat].includes(desc)) data.concepts[cat].push(desc);
  }

  const tx = {
    id: editId || uid(),
    date,
    amount,
    type,
    cat,
    desc,
    exec: $("fExec").checked,
    linkId: (type === "exp") ? ($("fLink").value || "") : null,
    updatedAt: Date.now()
  };

  if (editId) {
    const idx = data.txs.findIndex(x => String(x.id) === String(editId));
    if (idx >= 0) data.txs[idx] = tx;
    else data.txs.push(tx);
  } else {
    data.txs.push(tx);
  }

  saveData();
  closeSheet();
}

function edit(id) {
  const t = data.txs.find(x => String(x.id) === String(id));
  if (!t) return;

  editId = t.id;
  $("fAmount").value = t.amount;
  $("fDate").value = t.date;
  $("fExec").checked = !!t.exec;

  $("btnDel").style.display = "block";
  $("btnSave").innerText = "ACTUALIZAR";

  setType(t.type);
  pickCat(t.cat);

  $("fConcept").value = t.desc;
  renderConceptChips(t.cat);

  tempLink = t.linkId || "";
  $("fLink").value = tempLink;
  renderLinkChips();

  openSheet();
}

function delTx() {
  if (!editId) return;
  if (confirm("¿Eliminar?")) {
    data.txs = data.txs.filter(x => String(x.id) !== String(editId));
    saveData();
    closeSheet();
  }
}

/* ===== Utils UI existentes ===== */
function navMonth(n) {
  const i = $("dateInput");
  let [y,m] = i.value.split("-");
  const d = new Date(Number(y), Number(m) - 1 + n, 1);
  i.value = d.toISOString().slice(0,7);
  loadData();
}

function deleteCurrentMonth() {
  if (!confirm("¿BORRAR TODO EL MES ACTUAL?")) return;
  const ym = $("dateInput").value;
  data.txs = data.txs.filter(t => !String(t.date || "").startsWith(ym));
  saveData();
}

function nav(view) {
  document.querySelectorAll(".view-section").forEach(x => x.classList.remove("visible"));
  $("view-" + view).classList.add("visible");
  document.querySelectorAll(".nav-item").forEach(x => x.classList.remove("active"));
  $("nav-" + view).classList.add("active");
}

function backup() {
  const a = document.createElement("a");
  a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
  a.download = "Backup.json";
  a.click();
}

function restoreSmart(i) {
  const r = new FileReader();
  r.onload = e => {
    try {
      const parsed = JSON.parse(e.target.result);
      data = mergeCloud(data, parsed);
      saveData();
    } catch {
      alert("Backup inválido");
    }
  };
  r.readAsText(i.files[0]);
}

/* ===== Chart ===== */
function renderChart() {
  const ctx = $("myChart");
  if (!ctx) return;
  if (chartInstance) chartInstance.destroy();

  const map = {};
  for (const t of currentTxs) {
    if (t.type !== "exp") continue;
    const k = String(t.cat || "Otros");
    map[k] = (map[k] || 0) + (Number(t.amount) || 0);
  }

  chartInstance = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: Object.keys(map),
      datasets: [{
        data: Object.values(map),
        backgroundColor: ["#2563EB","#10B981","#F59E0B","#EF4444","#8B5CF6","#0EA5E9","#22C55E"],
        borderWidth: 0
      }]
    },
    options: { maintainAspectRatio: false, plugins: { legend: { position: "right", labels: { boxWidth: 10 } } } }
  });
}

/* ===== Exponer funciones usadas por tus onclick inline ===== */
window.forceSync = forceSync;
window.saveData = saveData;
window.loadData = loadData;
window.openSheet = openSheet;
window.closeSheet = closeSheet;
window.setType = setType;
window.navMonth = navMonth;
window.nav = nav;
window.deleteCurrentMonth = deleteCurrentMonth;
window.delTx = delTx;
window.backup = backup;
window.restoreSmart = restoreSmart;
</script>
