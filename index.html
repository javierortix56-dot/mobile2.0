<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>J&M Social Fin V38.0</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='128' fill='%23000000'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='central' text-anchor='middle' font-family='sans-serif' font-weight='800' font-size='320' fill='white'%3E$%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #FFFFFF; --bg-sec: #F8FAFC;
            --txt: #0F172A; --txt-sec: #64748B;
            --acc: #2563EB; --inc: #10B981; --exp: #EF4444;
            --border: #E2E8F0;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--txt); padding-bottom: 80px; padding-top: 60px; }

        /* --- HEADER COMPACTO --- */
        .top-nav {
            position: fixed; top: 0; left: 0; right: 0; height: 55px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); z-index: 50;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
        }
        .brand { font-weight: 900; font-size: 18px; letter-spacing: -0.5px; }
        .date-pill {
            background: #F1F5F9; border-radius: 20px; padding: 5px 12px; font-size: 12px; font-weight: 700;
            display: flex; align-items: center; gap: 8px; position: relative;
        }
        #dateInput { position: absolute; inset: 0; opacity: 0; width: 100%; }
        
        /* --- STORIES (INGRESOS) --- */
        .stories-tray {
            display: flex; gap: 12px; padding: 15px; overflow-x: auto; scrollbar-width: none;
            border-bottom: 1px solid var(--border); background: var(--bg);
        }
        .story-item { display: flex; flex-direction: column; align-items: center; min-width: 60px; cursor: pointer; }
        
        .ring-container {
            width: 56px; height: 56px; padding: 3px; border-radius: 50%;
            background: conic-gradient(var(--border) 100%, transparent 0); /* Default grey */
            display: flex; align-items: center; justify-content: center; position: relative;
            transition: 0.3s;
        }
        .avatar {
            width: 100%; height: 100%; background: #F1F5F9; border-radius: 50%; border: 2px solid var(--bg);
            display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--txt);
        }
        .story-badge {
            position: absolute; bottom: 0; right: 0; background: var(--inc); color: white;
            font-size: 9px; font-weight: 800; padding: 2px 4px; border-radius: 6px; border: 2px solid white;
        }
        .story-name { font-size: 11px; margin-top: 5px; font-weight: 600; text-align: center; max-width: 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- KPI BALANCE (MINI) --- */
        .mini-kpi { padding: 10px 15px; background: #F8FAFC; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--txt-sec); font-weight: 600; border-bottom: 1px solid var(--border); }
        .bal-val { font-size: 16px; font-weight: 800; color: var(--txt); }

        /* --- FEED LIST --- */
        .feed-list { padding: 0; list-style: none; margin: 0; }
        .feed-item {
            padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; gap: 12px;
            background: white; transition: 0.1s;
        }
        .feed-item:active { background: #F1F5F9; }
        .f-icon {
            width: 40px; height: 40px; border-radius: 50%; background: #F1F5F9; 
            display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;
        }
        .f-icon.inc { background: #ECFDF5; color: var(--inc); }
        .f-icon.exp { background: #FEF2F2; color: var(--exp); }
        
        .f-content { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .f-top { display: flex; justify-content: space-between; align-items: center; }
        .f-desc { font-weight: 700; font-size: 14px; color: var(--txt); }
        .f-amt { font-weight: 800; font-size: 14px; }
        .f-meta { font-size: 11px; color: var(--txt-sec); display: flex; gap: 8px; align-items: center; }
        .tag-pill { background: #F1F5F9; padding: 1px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; }
        .link-pill { background: #EFF6FF; color: var(--acc); }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
            background: white; border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-around; z-index: 100;
        }
        .nav-item { color: var(--txt-sec); font-size: 20px; padding: 10px; cursor: pointer; }
        .nav-item.active { color: var(--txt); }
        
        .fab-center {
            width: 50px; height: 50px; background: var(--txt); color: white; border-radius: 18px;
            display: flex; align-items: center; justify-content: center; font-size: 22px;
            transform: translateY(-10px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); cursor: pointer;
        }

        /* --- SHEET FORM (CHIPS STYLE) --- */
        .sheet { position: fixed; inset: 0; background: white; z-index: 200; transform: translateY(100%); transition: 0.3s; display: flex; flex-direction: column; }
        .sheet.open { transform: translateY(0); }
        .sheet-head { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .sheet-body { flex: 1; padding: 20px; overflow-y: auto; }
        
        .form-group { margin-bottom: 20px; }
        .lbl { display: block; font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--txt-sec); margin-bottom: 8px; }
        .big-input { width: 100%; border: none; font-size: 40px; font-weight: 900; color: var(--txt); background: transparent; padding: 0; letter-spacing: -1px; }
        .big-input::placeholder { color: #E2E8F0; }
        
        /* CHIPS SCROLLER */
        .chip-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .chip {
            padding: 8px 16px; border-radius: 20px; background: #F1F5F9; color: var(--txt-sec);
            font-size: 13px; font-weight: 700; border: 1px solid transparent; white-space: nowrap; cursor: pointer; transition: 0.2s;
        }
        .chip.active { background: var(--txt); color: white; border-color: var(--txt); }
        .chip.link-chip.active { background: var(--acc); border-color: var(--acc); }

        .btn-save { width: 100%; background: var(--acc); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 800; font-size: 16px; margin-top: 10px; }
        
        /* Utility */
        .hidden { display: none !important; }
        .loader { position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:300; display:flex; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="loader" class="loader hidden"><i class="fas fa-spinner fa-spin fa-2x"></i></div>

<nav class="top-nav">
    <div class="brand">J&M <i class="fas fa-circle" id="statusDot" style="font-size:8px; color:#CBD5E1; vertical-align:middle;"></i></div>
    <div class="date-pill">
        <i class="far fa-calendar"></i> <span id="monthDisplay">...</span>
        <input type="month" id="dateInput" onchange="loadData()">
    </div>
    <div style="font-size:18px;"><i class="fas fa-search"></i></div>
</nav>

<div class="stories-tray" id="storiesTray">
    </div>

<div class="mini-kpi">
    <span>Balance Mensual</span>
    <span class="bal-val" id="kpiBal">$0</span>
</div>

<div id="view-feed" class="view-section">
    <ul class="feed-list" id="feedList"></ul>
</div>

<div id="view-stats" class="view-section hidden" style="padding:15px;">
    <div style="height:300px;"><canvas id="myChart"></canvas></div>
    <button onclick="document.getElementById('fileIn').click()" style="margin-top:20px; width:100%; padding:10px; background:#F1F5F9; border:none; border-radius:8px; font-weight:700;">Restaurar Backup</button>
    <input type="file" id="fileIn" hidden onchange="restoreSmart(this)">
    <button onclick="backup()" style="margin-top:10px; width:100%; padding:10px; background:#F1F5F9; border:none; border-radius:8px; font-weight:700;">Descargar Backup</button>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="nav('feed')"><i class="fas fa-home"></i></div>
    <div class="fab-center" onclick="openNew()"><i class="fas fa-plus"></i></div>
    <div class="nav-item" onclick="nav('stats')"><i class="fas fa-chart-pie"></i></div>
</div>

<div class="sheet" id="sheet">
    <div class="sheet-head">
        <span style="font-weight:800; font-size:16px;">Transacción</span>
        <span onclick="closeSheet()" style="font-size:24px;"><i class="fas fa-times"></i></span>
    </div>
    <div class="sheet-body">
        <form id="txForm" onsubmit="saveTx(event)">
            
            <div class="form-group" style="text-align:center;">
                <input type="number" id="fAmount" class="big-input" placeholder="$0" step="0.01" required style="text-align:center;">
                <div style="margin-top:10px; display:flex; justify-content:center; gap:10px;">
                    <div class="chip active" id="type-exp" onclick="setType('exp')">Gasto</div>
                    <div class="chip" id="type-inc" onclick="setType('inc')">Ingreso</div>
                </div>
            </div>

            <div class="form-group">
                <label class="lbl">Concepto</label>
                <div class="chip-scroll" id="conceptChips"></div>
                <input type="text" id="fCustomDesc" placeholder="Escribe..." style="width:100%; padding:10px; border:1px solid #E2E8F0; border-radius:8px; margin-top:8px; display:none;">
            </div>

            <div class="form-group" id="catGroup">
                <label class="lbl">Categoría</label>
                <div class="chip-scroll" id="catChips"></div>
            </div>

            <div class="form-group" id="linkGroup">
                <label class="lbl" style="color:#2563EB;">¿Con qué pagas?</label>
                <div class="chip-scroll" id="linkChips"></div>
            </div>

            <div class="form-group">
                <label class="lbl">Detalles</label>
                <div style="display:flex; gap:10px;">
                    <input type="date" id="fDate" style="padding:10px; background:#F1F5F9; border:none; border-radius:8px; font-family:'Inter';">
                    <div style="display:flex; align-items:center; gap:5px; background:#F1F5F9; padding:0 10px; border-radius:8px;">
                        <input type="checkbox" id="fExec" checked> <label style="font-size:12px; font-weight:700;">Ejecutado</label>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-save">GUARDAR</button>
            <button type="button" onclick="delTx()" id="btnDel" style="width:100%; padding:15px; color:#EF4444; background:none; border:none; font-weight:700; display:none;">Eliminar</button>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec"; // TU URL AQUI
    let data = { txs: [], cats: { exp:['Super','Casa','Salidas','Servicios'], inc:['Sueldo','Ventas'] }, concepts: { 'Super':['Coto','Chino'], 'Casa':['Alquiler','Internet'] } };
    let editId = null, currentTxs = [], chartInstance = null;
    let selCat = '', selLink = null, fType='exp';

    window.onload = () => {
        const d = new Date();
        document.getElementById('dateInput').value = d.toISOString().slice(0, 7);
        document.getElementById('fDate').value = d.toISOString().split('T')[0];
        forceSync();
    };

    /* --- DATA & SYNC --- */
    async function forceSync() {
        loader(true);
        try {
            let res = await fetch(API_URL);
            let cloud = await res.json();
            if(cloud.txs) { data = cloud; loadData(); document.getElementById('statusDot').style.color='#10B981'; }
        } catch(e) { document.getElementById('statusDot').style.color='#EF4444'; }
        loader(false);
    }
    
    async function saveData() {
        loader(true);
        try { await fetch(API_URL, {method:'POST', body:JSON.stringify(data)}); loadData(); } catch(e){}
        loader(false);
    }

    function loadData() {
        const ym = document.getElementById('dateInput').value;
        const [y, m] = ym.split('-');
        const months = ["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"];
        document.getElementById('monthDisplay').innerText = `${months[parseInt(m)-1]} ${y}`;
        
        currentTxs = (data.txs || []).filter(t => t.date.startsWith(ym));
        renderStories();
        renderFeed();
        calcTotal();
    }

    /* --- RENDERERS --- */
    function renderStories() {
        const tray = document.getElementById('storiesTray');
        const incomes = currentTxs.filter(t => t.type === 'inc');
        const exps = currentTxs.filter(t => t.type === 'exp');
        
        let html = '';
        
        // 1. Botón de "Todo" (Resumen) o "Fondo"
        html += `
        <div class="story-item" onclick="filterFeed(null)">
            <div class="ring-container" style="background: conic-gradient(#0F172A 100%, transparent 0);">
                <div class="avatar" style="background:#0F172A; color:white;"><i class="fas fa-wallet"></i></div>
            </div>
            <span class="story-name">Todo</span>
        </div>`;

        // 2. Ingresos Individuales
        incomes.forEach(inc => {
            const linked = exps.filter(e => e.linkId == inc.id).reduce((a,b)=>a+b.amount,0);
            const total = inc.amount || 1; 
            const pct = Math.min((linked/total)*100, 100);
            const remain = total - linked;
            
            // Color logic: Verde si queda mucho, Rojo si queda poco
            const color = remain < 0 ? '#EF4444' : (pct > 90 ? '#F59E0B' : '#10B981');
            
            html += `
            <div class="story-item" onclick="filterFeed(${inc.id})" oncontextmenu="quickAdd(${inc.id}); return false;">
                <div class="ring-container" style="background: conic-gradient(${color} ${pct}%, #E2E8F0 0);">
                    <div class="avatar"><i class="fas fa-dollar-sign"></i></div>
                    <div class="story-badge" style="background:${color}">${Math.floor(remain/1000)}k</div>
                </div>
                <span class="story-name">${inc.desc}</span>
            </div>`;
        });
        tray.innerHTML = html;
    }

    function renderFeed(filterId = null) {
        const list = document.getElementById('feedList');
        list.innerHTML = '';
        
        let txs = [...currentTxs];
        if(filterId) {
            // Mostrar el ingreso seleccionado Y sus gastos
            txs = txs.filter(t => t.id == filterId || t.linkId == filterId);
        }
        
        // Sort: Fecha DESC
        txs.sort((a,b) => b.date.localeCompare(a.date) || b.id - a.id);

        txs.forEach(t => {
            const isInc = t.type === 'inc';
            const li = document.createElement('li');
            li.className = 'feed-item';
            li.onclick = () => edit(t.id);
            
            // Icon logic
            const icon = isInc ? 'fa-arrow-down' : 'fa-shopping-bag';
            
            li.innerHTML = `
                <div class="f-icon ${isInc?'inc':'exp'}"><i class="fas ${icon}"></i></div>
                <div class="f-content">
                    <div class="f-top">
                        <span class="f-desc" style="${t.exec?'':'opacity:0.5'}">${t.desc}</span>
                        <span class="f-amt" style="color:${isInc?'var(--inc)':'var(--txt)'}">
                            ${isInc?'+':'-'} $${Math.floor(t.amount).toLocaleString()}
                        </span>
                    </div>
                    <div class="f-meta">
                        <span class="tag-pill">${t.cat}</span>
                        <span>${t.date.split('-')[2]}/${t.date.split('-')[1]}</span>
                        ${t.linkId && !isInc ? '<span class="tag-pill link-pill"><i class="fas fa-link"></i> Linked</span>' : ''}
                    </div>
                </div>
            `;
            list.appendChild(li);
        });
        
        if(txs.length === 0) list.innerHTML = '<div style="padding:40px; text-align:center; color:#94A3B8;">No hay movimientos</div>';
    }

    function calcTotal() {
        const inc = currentTxs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0);
        const exp = currentTxs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);
        document.getElementById('kpiBal').innerText = `$ ${(inc-exp).toLocaleString()}`;
        renderChart();
    }

    /* --- FORM LOGIC (CHIPS) --- */
    function openNew() { resetForm(); document.getElementById('sheet').classList.add('open'); }
    function closeSheet() { document.getElementById('sheet').classList.remove('open'); }
    
    function resetForm() {
        editId = null;
        document.getElementById('txForm').reset();
        document.getElementById('btnDel').style.display='none';
        document.getElementById('fDate').value = new Date().toISOString().split('T')[0];
        setType('exp');
    }

    function setType(t) {
        fType = t;
        document.getElementById('type-exp').className = `chip ${t=='exp'?'active':''}`;
        document.getElementById('type-inc').className = `chip ${t=='inc'?'active':''}`;
        
        document.getElementById('linkGroup').style.display = t=='exp'?'block':'none';
        
        renderCatChips();
    }

    function renderCatChips() {
        const div = document.getElementById('catChips');
        div.innerHTML = '';
        (data.cats[fType] || []).forEach(c => {
            const chip = document.createElement('div');
            chip.className = `chip ${selCat === c ? 'active' : ''}`;
            chip.innerText = c;
            chip.onclick = () => { selCat=c; renderCatChips(); renderConceptChips(c); };
            div.appendChild(chip);
        });
        // Auto select first if none
        if(!selCat && data.cats[fType].length) { selCat = data.cats[fType][0]; renderConceptChips(selCat); }
    }

    function renderConceptChips(cat) {
        const div = document.getElementById('conceptChips');
        div.innerHTML = '';
        const concepts = (data.concepts[cat] || []);
        
        concepts.forEach(c => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.innerText = c;
            chip.onclick = () => { 
                document.querySelectorAll('#conceptChips .chip').forEach(x=>x.classList.remove('active'));
                chip.classList.add('active');
                document.getElementById('fCustomDesc').style.display='none';
                document.getElementById('fCustomDesc').value = c; // Hack to store value
            };
            div.appendChild(chip);
        });
        
        // Add + button
        const add = document.createElement('div');
        add.className = 'chip';
        add.innerHTML = '<i class="fas fa-plus"></i>';
        add.onclick = () => {
             document.querySelectorAll('#conceptChips .chip').forEach(x=>x.classList.remove('active'));
             add.classList.add('active');
             document.getElementById('fCustomDesc').style.display='block';
             document.getElementById('fCustomDesc').value = '';
             document.getElementById('fCustomDesc').focus();
        };
        div.appendChild(add);
        
        // Render Links (Incomes)
        renderLinkChips();
    }

    function renderLinkChips() {
        const div = document.getElementById('linkChips');
        div.innerHTML = '';
        
        const none = document.createElement('div');
        none.className = `chip ${selLink===null?'active link-chip':''}`;
        none.innerText = 'General';
        none.onclick = () => { selLink=null; renderLinkChips(); };
        div.appendChild(none);

        const incomes = currentTxs.filter(t => t.type === 'inc');
        incomes.forEach(inc => {
            const chip = document.createElement('div');
            chip.className = `chip ${selLink==inc.id?'active link-chip':''}`;
            chip.innerText = inc.desc;
            chip.onclick = () => { selLink=inc.id; renderLinkChips(); };
            div.appendChild(chip);
        });
    }

    /* --- ACTIONS --- */
    function saveTx(e) {
        e.preventDefault();
        const amt = parseFloat(document.getElementById('fAmount').value);
        if(!amt) return;
        
        let desc = document.getElementById('fCustomDesc').value;
        // If custom desc used, add to memory
        if(desc && selCat && !data.concepts[selCat].includes(desc)) {
            data.concepts[selCat].push(desc);
        }

        const tx = {
            id: editId || Date.now(),
            date: document.getElementById('fDate').value,
            amount: amt,
            type: fType,
            cat: selCat,
            desc: desc || selCat,
            exec: document.getElementById('fExec').checked,
            linkId: fType === 'exp' ? selLink : null
        };
        
        if(editId) {
            const idx = data.txs.findIndex(x=>x.id==editId);
            data.txs[idx] = tx;
        } else {
            data.txs.push(tx);
        }
        
        saveData();
        closeSheet();
    }
    
    function edit(id) {
        const t = data.txs.find(x=>x.id==id);
        if(!t) return;
        editId = id;
        document.getElementById('fAmount').value = t.amount;
        document.getElementById('fDate').value = t.date;
        document.getElementById('fExec').checked = t.exec;
        document.getElementById('fCustomDesc').value = t.desc; // Pre-fill logic simplified
        
        setType(t.type);
        selCat = t.cat; renderCatChips();
        selLink = t.linkId; renderLinkChips();
        renderConceptChips(t.cat);
        
        // Visual updates for chips
        document.getElementById('btnDel').style.display='block';
        document.getElementById('sheet').classList.add('open');
    }

    function quickAdd(incId) {
        if(confirm("¿Agregar gasto rápido a este ingreso?")) {
             openNew();
             selLink = incId;
             renderLinkChips();
        }
    }

    function delTx() {
        if(confirm("¿Eliminar?")) {
            data.txs = data.txs.filter(x => x.id != editId);
            saveData();
            closeSheet();
        }
    }

    /* --- UTIL --- */
    function filterFeed(id) { renderFeed(id); }
    function nav(v) { 
        document.querySelectorAll('.view-section').forEach(x=>x.classList.add('hidden'));
        document.getElementById('view-'+v).classList.remove('hidden');
    }
    function loader(s) { document.getElementById('loader').className = s ? 'loader' : 'loader hidden'; }
    function backup() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); a.download=`Back_V38.json`; a.click(); }
    function restoreSmart(i) { const r=new FileReader(); r.onload=e=>{ data=JSON.parse(e.target.result); saveData(); }; r.readAsText(i.files[0]); }
    
    function renderChart() {
        // Chart.js logic simplified
        const ctx = document.getElementById('myChart');
        if(chartInstance) chartInstance.destroy();
        const map = {}; 
        currentTxs.filter(t=>t.type=='exp').forEach(t=>{ map[t.cat]=(map[t.cat]||0)+t.amount; });
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: Object.keys(map), datasets: [{ data: Object.values(map), backgroundColor: ['#3B82F6','#10B981','#F59E0B','#EF4444'] }] }
        });
    }
</script>
</body>
</html>
